version: 2.1

workflows:
  version: 2
  build-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: main

jobs:
  build:
    working_directory: ~/Source-Code
    docker:
      - image: cimg/node:20.14.0
    steps:
      - checkout
      - restore_cache:
          key: dependency-cache-{{ checksum "package-lock.json" }}
      - run:
          name: Install dependencies
          command: npm install
      - run:
          name: Run tests
          command: |
            CI=true npm test -- --watchAll=false --passWithNoTests
      - save_cache:
          key: dependency-cache-{{ checksum "package-lock.json" }}
          paths:
            - ./node_modules
      - persist_to_workspace:
          root: .
          paths: .

  deploy:
    working_directory: ~/Source-Code
    docker:
      - image: cimg/node:20.14.0
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Setup SSH
          command: |
            mkdir -p ~/.ssh
            echo "$SSH_PRIVATE_KEY" > ~/.ssh/ec2_key
            chmod 600 ~/.ssh/ec2_key
            ssh-keyscan $EC2_PUBLIC_DNS >> ~/.ssh/known_hosts
      - run:
          name: Create deployment script
          command: |
            # Create deploy.sh using simple echo statements
            echo '#!/usr/bin/env bash' > deploy.sh
            echo 'set -e' >> deploy.sh
            
            # System setup
            echo 'sudo apt-get update' >> deploy.sh
            echo 'if ! command -v node &>/dev/null; then' >> deploy.sh
            echo '  curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -' >> deploy.sh
            echo '  sudo apt-get install -y nodejs nginx' >> deploy.sh
            echo '  sudo npm install -g npm@latest pm2' >> deploy.sh
            echo 'fi' >> deploy.sh
            
            # Application deployment
            echo 'rm -rf Source-Code' >> deploy.sh
            echo 'git clone https://github.com/GroupA-DevOpsSec-2025/Source-Code.git' >> deploy.sh
            echo 'cd Source-Code' >> deploy.sh
            echo 'npm install' >> deploy.sh
            echo 'npm run build' >> deploy.sh
            echo 'sudo rm -rf /var/www/html/*' >> deploy.sh
            echo 'sudo cp -a build/* /var/www/html/' >> deploy.sh
            echo 'sudo chown -R www-data:www-data /var/www/html' >> deploy.sh
            
            # SSL Certificate Setup - using multiple echo statements
            echo 'sudo mkdir -p /etc/ssl/private /etc/ssl/certs' >> deploy.sh
            echo 'echo "-----BEGIN PRIVATE KEY-----" | sudo tee /etc/ssl/private/privatekey.pem >/dev/null' >> deploy.sh
            echo 'echo "$PRIVATE_KEY" | sudo tee -a /etc/ssl/private/privatekey.pem >/dev/null' >> deploy.sh
            echo 'echo "-----END PRIVATE KEY-----" | sudo tee -a /etc/ssl/private/privatekey.pem >/dev/null' >> deploy.sh
            echo 'echo "-----BEGIN CERTIFICATE-----" | sudo tee /etc/ssl/certs/server.crt >/dev/null' >> deploy.sh
            echo 'echo "$SERVER_CERT" | sudo tee -a /etc/ssl/certs/server.crt >/dev/null' >> deploy.sh
            echo 'echo "-----END CERTIFICATE-----" | sudo tee -a /etc/ssl/certs/server.crt >/dev/null' >> deploy.sh
            echo 'sudo chmod 600 /etc/ssl/private/privatekey.pem' >> deploy.sh
            echo 'sudo chmod 644 /etc/ssl/certs/server.crt' >> deploy.sh
            
            # Nginx Configuration - using multiple echo statements
            echo 'echo "server {" | sudo tee /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "  listen 80;" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "  server_name $EC2_PUBLIC_DNS;" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "  return 301 https://\$host\$request_uri;" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "}" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "server {" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "  listen 443 ssl;" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "  server_name $EC2_PUBLIC_DNS;" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "  ssl_certificate /etc/ssl/certs/server.crt;" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "  ssl_certificate_key /etc/ssl/private/privatekey.pem;" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "  root /var/www/html;" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "  location / {" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "    try_files \$uri /index.html;" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "  }" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "  location /api {" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "    proxy_pass http://localhost:3001;" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "    proxy_http_version 1.1;" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "    proxy_set_header Upgrade \$http_upgrade;" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "    proxy_set_header Connection \"upgrade\";" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "    proxy_set_header Host \$host;" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "    proxy_set_header X-Real-IP \$remote_addr;" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "  }" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            echo 'echo "}" | sudo tee -a /etc/nginx/sites-available/todo-app >/dev/null' >> deploy.sh
            
            # Finalize setup
            echo 'sudo ln -sf /etc/nginx/sites-available/todo-app /etc/nginx/sites-enabled/' >> deploy.sh
            echo 'sudo rm -f /etc/nginx/sites-enabled/default' >> deploy.sh
            echo 'cd server' >> deploy.sh
            echo 'npm install' >> deploy.sh
            echo 'pm2 delete todo-api 2>/dev/null || true' >> deploy.sh
            echo 'pm2 start ./bin/www --name todo-api' >> deploy.sh
            echo 'pm2 save' >> deploy.sh
            echo 'pm2 startup || true' >> deploy.sh
            echo 'sudo nginx -t && sudo systemctl restart nginx' >> deploy.sh
            
            chmod +x deploy.sh
      - run:
          name: Deploy application
          command: |
            scp -i ~/.ssh/ec2_key deploy.sh $EC2_USERNAME@$EC2_PUBLIC_DNS:~
            ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no \
              $EC2_USERNAME@$EC2_PUBLIC_DNS \
              "export EC2_PUBLIC_DNS='$EC2_PUBLIC_DNS'; \
               export PRIVATE_KEY='$PRIVATE_KEY'; \
               export SERVER_CERT='$SERVER_CERT'; \
               bash ~/deploy.sh"